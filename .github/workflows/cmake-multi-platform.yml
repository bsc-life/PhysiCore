name: CMake Build on Ubuntu, Windows, and MacOS

on:
  push:
    branches:
      - 'main'
  pull_request:
    branches:
      - '**'

jobs:
  build:
    runs-on: ${{ matrix.os }}

    env:
      # This is just a placeholder, vcpkg step will set it up
      VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/.vcpkg-cache

    strategy:
      fail-fast: false

      matrix:
        include:
          - os: ubuntu-latest
            preset: gcc-release-no-cuda
          - os: ubuntu-latest
            preset: llvm-release-no-cuda
          - os: macos-latest
            preset: appleclang-release
          - os: windows-latest
            preset: msvc-release-no-cuda

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Install libomp
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y libomp-dev

    - name: Install CUDA Toolkit
      if: matrix.os == 'ubuntu-latest' || matrix.os == 'windows-latest'
      uses: N-Storm/cuda-toolkit@v0.2.28
      with:
        method: 'network'

    - name: Set up vcpkg
      uses: lukka/run-vcpkg@v11
      env:
        VCPKG_BINARY_SOURCES: default,readwrite

    - name: Set up binary cache
      uses: actions/cache@v4
      with:
        path: ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
        # Invalidate cache when vcpkg manifests or overlay ports change
        key: ${{ runner.name }}-vcpkg-binary-cache-${{ hashFiles('vcpkg*.json', 'ports-overlays/**') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-binary-cache-
          ${{ runner.name }}-vcpkg-binary-cache-

    - name: Run CMake consuming CMakePreset.json and run vcpkg to build packages
      uses: lukka/run-cmake@v10
      with:
        workflowPreset: ${{ matrix.preset }}
